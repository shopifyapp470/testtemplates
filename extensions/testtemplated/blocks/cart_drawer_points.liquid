{% comment %}
  LOYALTY REDEEM DRAWER - ADVANCED VERSION
  - Disables UI instead of hiding after discount
  - Auto-re-enables if discount is removed from cart/checkout
  - Syncs state on cart changes
{% endcomment %}

<div id="loyalty-extension-wrapper" style="display: none;">
  <section class="app-proxy-section" style="padding: 10px 15px;">
    <div style="border: 2px solid #3498db; border-radius: 4px; overflow: hidden; background: #fff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
      
      <div style="background-color: #e8fbf3; padding: 12px; display: flex; align-items: center; border-bottom: 1px solid #eee;">
        <div style="width: 18px; height: 18px; border: 1.5px solid #444; border-radius: 3px; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
        </div>
        <span style="font-size: 14px; font-weight: 600; color: #333;">Redeem Reward Points</span>
      </div>

      <div id="proxy-app-container" style="padding: 15px;" data-customer-id="{{ customer.id }}">
        {% if customer %}
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="font-size: 20px; font-weight: 700; color: #2d3436;">
              Balance <span style="font-size: 12px; font-weight: 400; color: #636e72; margin-left: 4px;">(Reward Points)</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <img src="{{ 'Group.png' | asset_url }}" alt="Icon" style="width: 24px; height: 24px; object-fit: contain; display: block;">
              <span id="points_balance_display" style="font-size: 22px; font-weight: 700; color: #2d3436;">...</span>
            </div>
          </div>

          <div id="redeem_action_area">
            <div style="display: flex; gap: 10px;">
              <div style="position: relative; flex: 1;">
                <input type="number" id="user_input_value" 
                       style="width: 100%; padding: 10px; border: 1px solid #dfe6e9; border-radius: 6px; font-size: 16px; font-weight: 700; color: #2d3436; outline: none;"
                       placeholder="0">
                <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #b2bec3; font-size: 13px;">Points</span>
              </div>
              <button type="button" id="btn_submit_redeem" onclick="submitCustomerData()" 
                      style="background-color: {{ block.settings.button_bg_color | default: '#d63384' }}; color: {{ block.settings.button_text_color | default: '#ffffff' }}; padding: 0 20px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer;">
                Redeem
              </button>
            </div>
            <div id="input_validation_error" style="color: #e74c3c; font-size: 12px; margin-top: 8px; font-weight: 500; display: none;"></div>
          </div>

          <div id="api_response_message" style="margin-top: 12px; font-size: 14px;"></div>
          
          <div id="coupon_tag_area" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; display: none;">
             <div style="display: flex; align-items: center; background: #fee2e2; padding: 10px 12px; border-radius: 6px; border: 1.5px dashed #ef4444;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="margin-right: 10px;"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                <span id="active_coupon_text" style="font-size: 14px; color: #b91c1c; font-weight: 700; letter-spacing: 1px;"></span>
             </div>
          </div>

          <div id="api_loading" style="display:none; margin-top:10px; font-size: 12px; color: #636e72;">Processing...</div>
        {% else %}
          <p style="text-align: center; color: #636e72;">Please login to see rewards.</p>
        {% endif %}
      </div>
    </div>
  </section>
</div>

<script>
let isSubmitting = false;

document.addEventListener("DOMContentLoaded", function() {
  initExtension();
});

function initExtension() {
  const source = document.getElementById('loyalty-extension-wrapper');
  const targetSelector = '.drawer__cart-items-wrapper'; 
  
  const moveElement = () => {
    const target = document.querySelector(targetSelector);
    if (target && source && !document.getElementById('injected-loyalty-app')) {
      const appContainer = document.createElement('div');
      appContainer.id = 'injected-loyalty-app';
      appContainer.innerHTML = source.innerHTML; 
      target.insertAdjacentElement('afterend', appContainer);
      fetchCustomerPoints();
      setupInputValidation();
    }
  };

  moveElement();
  const observer = new MutationObserver(() => { if(!isSubmitting) moveElement(); });
  observer.observe(document.body, { childList: true, subtree: true });
}

async function fetchCustomerPoints() {
  const wrapper = document.getElementById('injected-loyalty-app');
  if (!wrapper || isSubmitting) return;

  const btn = wrapper.querySelector('#btn_submit_redeem');
  const input = wrapper.querySelector('#user_input_value');
  const responseDiv = wrapper.querySelector('#api_response_message');
  const couponArea = wrapper.querySelector('#coupon_tag_area');
  const couponText = wrapper.querySelector('#active_coupon_text');
  const customerId = wrapper.querySelector('#proxy-app-container').getAttribute('data-customer-id');

  try {
    const cartRes = await fetch('/cart.js');
    const cart = await cartRes.json();
    
    // Check if any discount is actually applied in the cart
    const hasDiscountInCart = cart.cart_level_discount_applications && cart.cart_level_discount_applications.length > 0;
    const attributeReward = cart.attributes ? cart.attributes['active_reward_code'] : null;

    const res = await fetch(`/apps/public?customerId=${customerId}`);
    const data = await res.json();

    if (data.success) {
      wrapper.querySelector('#points_balance_display').innerText = data.pointvalue;
      input.setAttribute('data-max-points', data.pointvalue);

      // Condition: Show disabled only if attribute exists AND cart has discount
      if (attributeReward && hasDiscountInCart) {
        setUIState(wrapper, true, attributeReward);
      } else {
        // If discount was deleted from checkout/cart, re-enable everything
        setUIState(wrapper, false, "");
        if(attributeReward && !hasDiscountInCart) {
           // Clean up the stale attribute
           await fetch('/cart/update.js', {
             method: 'POST',
             headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({ attributes: { 'active_reward_code': null } })
           });
        }
      }
    }
  } catch (err) { console.error("Sync error:", err); }
}

function setUIState(wrapper, isDisabled, couponCode) {
  const btn = wrapper.querySelector('#btn_submit_redeem');
  const input = wrapper.querySelector('#user_input_value');
  const responseDiv = wrapper.querySelector('#api_response_message');
  const couponArea = wrapper.querySelector('#coupon_tag_area');
  const couponText = wrapper.querySelector('#active_coupon_text');

  if (isDisabled) {
    btn.disabled = true;
    btn.style.opacity = "0.5";
    btn.style.cursor = "not-allowed";
    input.disabled = true;
    input.style.backgroundColor = "#f5f5f5";
    responseDiv.innerHTML = `<span style="color: #27ae60; font-weight:600;">âœ” Discount Applied.</span>`;
    couponArea.style.display = "block";
    couponText.innerText = couponCode;
  } else {
    btn.disabled = false;
    btn.style.opacity = "1";
    btn.style.cursor = "pointer";
    input.disabled = false;
    input.style.backgroundColor = "#ffffff";
    responseDiv.innerHTML = "";
    couponArea.style.display = "none";
  }
}

function setupInputValidation() {
  const wrapper = document.getElementById('injected-loyalty-app');
  if (!wrapper) return;
  const inputField = wrapper.querySelector('#user_input_value');
  const submitBtn = wrapper.querySelector('#btn_submit_redeem');
  const errorDiv = wrapper.querySelector('#input_validation_error');

  inputField.addEventListener('input', function() {
    const max = parseInt(this.getAttribute('data-max-points') || 0);
    const current = parseInt(this.value) || 0;
    if (current > max) {
      errorDiv.innerText = "Insufficient balance!";
      errorDiv.style.display = "block";
      submitBtn.disabled = true;
    } else {
      errorDiv.style.display = "none";
      submitBtn.disabled = false;
    }
  });
}

async function submitCustomerData() {
  const wrapper = document.getElementById('injected-loyalty-app');
  const inputField = wrapper.querySelector('#user_input_value');
  const loadingDiv = wrapper.querySelector('#api_loading');
  const customerId = wrapper.querySelector('#proxy-app-container').getAttribute('data-customer-id');

  if (!inputField.value || inputField.value <= 0) return;

  isSubmitting = true;
  loadingDiv.style.display = 'block';

  try {
    const res = await fetch('/apps/public', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ customerId: customerId, userValue: inputField.value })
    });
    const data = await res.json();

    if (data.success) {
      const couponCode = data.discountTitle;

      await fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ attributes: { 'active_reward_code': couponCode } })
      });

      await fetch(`/discount/${couponCode}`);

      loadingDiv.style.display = 'none';
      setUIState(wrapper, true, couponCode);

      setTimeout(() => {
          isSubmitting = false;
          fetchCustomerPoints();
      }, 2000);

    } else {
      isSubmitting = false;
      loadingDiv.style.display = 'none';
      alert(data.message || "Error redeeming points");
    }
  } catch (err) {
    isSubmitting = false;
    loadingDiv.style.display = 'none';
  }
}

// Watch for cart drawer openings to refresh state
document.addEventListener('click', function(e) {
  if (e.target.closest('.header__icon--cart') || e.target.closest('#cart-icon-bubble') || e.target.closest('.cart-link')) {
    setTimeout(fetchCustomerPoints, 500);
  }
});
</script>

{% schema %}
{
  "name": "Reward Point Drawer",
  "target": "body",
  "settings": [
    { "type": "color", "id": "button_bg_color", "label": "Redeem Button Color", "default": "#d63384" },
    { "type": "color", "id": "button_text_color", "label": "Button Text Color", "default": "#ffffff" }
  ]
}
{% endschema %}
